# ADR-002: Безопасное управление сессиями через HttpOnly Cookies

**Дата:** 2025-10-22

**Статус:** Accepted

**PR:** [P02](https://github.com/hse-secdev-2025-fall/course-project-AvtorPaka/pull/5)

## Context
Сервису требуется механизм для поддержания состояния аутентификации пользователя между запросами. Основные угрозы, связанные с сессиями, — это их кража через XSS (**Risk R2**), межсайтовая подделка запроса (CSRF, **Risk R4**) и перехват в незащищенной сети (**Risk R5**).

## Decision
Мы реализуем сессии на стороне сервера (server-side sessions), хранящиеся в основной базе данных PostgreSQL.

1.  **Идентификатор сессии:** После успешного логина генерируется криптографически случайный `session_id`.
2.  **Хранение на клиенте:** `session_id` передается клиенту через cookie.
3.  **Атрибуты Cookie:** Cookie устанавливается со следующими обязательными флагами безопасности:
    - `HttpOnly`: Защищает от кражи через XSS, делая cookie недоступным для JavaScript.
    - `Secure`: Разрешает отправку cookie только по HTTPS-соединению.
    - `SameSite=Lax`: Является основной мерой защиты от CSRF-атак.
4.  **Время жизни:** Сессия в базе данных имеет TTL **3 часа**, как определено в **NFR-03**.

Это решение комплексно закрывает требования `NFR-03`, `NFR-07`, `NFR-08`.

## Alternatives

1.  **Хранение JWT в LocalStorage:**
    *   **Плюсы:** Не требует запросов к БД для валидации.
    *   **Минусы:** **Крайне уязвимо к XSS.** Любой скрипт на странице может украсть токен.
2.  **Хранение JWT в Cookie:**
    *   **Плюсы:** Более безопасно, чем LocalStorage.
    *   **Минусы:** Сложности с отзывом токена (logout), размер токена может быть большим.
3.  **Stateless Session Cookie (зашифрованный payload):**
    *   **Плюсы:** Полностью stateless.
    *   **Минусы:** Невозможно отозвать сессию, усложняет управление ключами шифрования.

**Вывод:** Server-side сессии с `HttpOnly` cookie предоставляют наилучший уровень безопасности и контроля для веб-приложения.

## Consequences
- **Плюсы:**
    - Высокий уровень защиты от XSS и CSRF.
    - Полный контроль над сессиями на сервере, включая возможность принудительного завершения.
- **Минусы:**
    - Требует одного дополнительного запроса к БД на каждый аутентифицированный запрос (`F9`) для валидации сессии, что создает небольшую дополнительную нагрузку.

## Links
- **NFR:** `NFR-03` (Контроль времени жизни сессии), `NFR-07` (Безопасные атрибуты cookie), `NFR-08` (Защита от CSRF-атак)
- **Threat Model:** `F6`, `F7`, `F9`, `Risks R2, R4, R5, R9`
- **BDD:** Feature: Безопасные атрибуты cookie сессии
