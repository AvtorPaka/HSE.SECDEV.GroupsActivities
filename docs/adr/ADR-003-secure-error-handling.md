# ADR-003: Стандартизированная и безопасная обработка ошибок

**Дата:** 2025-10-22

**Статус:** Accepted

**PR:** [P02](https://github.com/hse-secdev-2025-fall/course-project-AvtorPaka/pull/5)

## Context
По умолчанию веб-фреймворки могут раскрывать внутреннюю информацию при возникновении ошибок (например, стектрейсы), что помогает злоумышленникам в профилировании системы. Кроме того, разные ответы на запросы с существующими и несуществующими пользователями могут привести к утечке информации о пользовательской базе (**Risk R6**). Необходимо стандартизировать ответы об ошибках, чтобы они были одновременно информативными для клиента и безопасными.

## Decision
Мы внедряем централизованный обработчик исключений (`ExceptionHandler`), который перехватывает все ошибки приложения.

1.  **Структура ответа:** Все ошибки возвращаются в едином формате JSON: `{"error": {"code": "...", "message": "...", "details": [...]}}`.
2.  **Маскирование ошибок аутентификации:** Все исключения, связанные с неверными учетными данными (`InvalidUserCredentialsException`, `AuthUserNotFoundException`), отображаются в один и тот же публичный ответ: `status: 200`, `code: "invalid_credentials"`, `message: "Invalid credentials"`. Это полностью соответствует **NFR-04**.
3.  **Обработка непредвиденных ошибок:** Все остальные, неперехваченные исключения логируются с полным стектрейсом, но клиенту возвращается общее сообщение с `status: 500` и `code: "internal_error"`.

## Alternatives

1.  **Использовать стандартные обработчики FastAPI:**
    *   **Плюсы:** Не требует дополнительного кода.
    *   **Минусы:** Раскрывает стектрейсы при `debug=True` и не позволяет кастомизировать формат ответа и логику маскирования.
2.  **Внедрить стандарт RFC 7807 (Problem Details):**
    *   **Плюсы:** Общепринятый стандарт для описания ошибок в HTTP API.
    *   **Минусы:** Более сложная структура (`type`, `title`, `status`, `detail`, `instance`). Наша текущая, более простая структура полностью удовлетворяет потребности проекта.

**Вывод:** Наш кастомный обработчик — это простой и эффективный способ достичь необходимого уровня безопасности и консистентности API.

## Consequences
- **Плюсы:**
    - Защита от утечки информации о структуре кода и существовании пользователей.
    - Единообразный и предсказуемый формат ошибок для всех клиентов API.
    - Централизованное место для логирования всех типов ошибок.
- **Минусы:**
    - Формат ответа является проприетарным и требует документирования для потребителей API.

## Links
- **NFR:** `NFR-04` (Маскирование PII в ошибках)
- **Threat Model:** `F1`, `Risk R6` (Раскрытие информации о существовании пользователя)
- **Тесты:** [e2e](https://github.com/AvtorPaka/HSE.SECDEV.GroupsActivities/blob/main/tests/e2e/test_auth.py)  /  [unit](https://github.com/AvtorPaka/HSE.SECDEV.GroupsActivities/blob/main/tests/unit/test_errors_format.py)
