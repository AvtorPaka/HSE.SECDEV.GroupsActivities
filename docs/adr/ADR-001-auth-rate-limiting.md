# ADR-001: Защита эндпоинтов аутентификации с помощью Rate Limiting на API Gateway

**Дата:** 2025-10-22

**Статус:** Accepted

**PR:** [P05](https://github.com/hse-secdev-2025-fall/course-project-AvtorPaka/pull/11)

## Context
Эндпоинты аутентификации (`/auth/login`, `/auth/register`) являются публичными и наиболее уязвимыми для атак методом перебора (brute-force). Без ограничений злоумышленник может отправлять тысячи запросов в секунду, пытаясь подобрать пароль или вызвать отказ в обслуживании (DoS), перегружая сервис и базу данных. Это напрямую связано с риском **R1 (Блокировка сервиса из-за brute-force)**.

## Decision
Мы внедряем механизм ограничения частоты запросов (rate limiting) на уровне **API Gateway (Nginx)** для всех запросов, направляемых на `location /auth/`. Это позволяет отсекать вредоносный трафик еще до того, как он достигнет бэкенд-сервиса.

1.  **Инструмент:** Стандартный модуль Nginx `ngx_http_limit_req_module`.
2.  **Конфигурация:**
    - `limit_req_zone`: Создается зона в памяти (`auth_limit`) для отслеживания запросов по IP-адресу клиента (`$binary_remote_addr`).
    - `rate`: Установлен порог в **10 запросов в минуту (10r/m)**.
    - `burst`: Установлено значение `5`, чтобы сгладить кратковременные всплески и не блокировать легитимных пользователей при быстрой отправке нескольких запросов.
3.  **Ответ при превышении:** Nginx немедленно отвечает статусом `429 Too Many Requests` (`limit_req_status 429`).

Это решение напрямую реализует требование **NFR-02** на уровне инфраструктуры.

## Alternatives

1.  **Реализация на уровне приложения (Python/FastAPI):**
    *   **Плюсы:** Логика контролируется кодом приложения, легко покрывается unit-тестами.
    *   **Минусы:** **Основной недостаток** — вредоносные запросы потребляют ресурсы приложения (CPU, память, сетевые соединения) еще до того, как будут отклонены. Это неэффективно.
2.  **Использование облачного WAF/CDN (Cloudflare, AWS WAF):**
    *   **Плюсы:** Наиболее мощное решение, останавливает трафик еще до нашей инфраструктуры, предоставляет защиту от DDoS.
    *   **Минусы:** Дополнительные затраты, зависимость от стороннего вендора, усложнение конфигурации.
3.  **Полная блокировка IP (Fail2Ban):**
    *   **Плюсы:** Полностью блокирует атакующий IP на длительное время.
    *   **Минусы:** Может заблокировать легитимных пользователей за одним NAT, сложнее в настройке в контейнеризированной среде.

**Вывод:** Реализация на Nginx является "золотой серединой". Она чрезвычайно производительна, снимает нагрузку с бэкенда и находится под нашим полным контролем.

## Consequences
- **Плюсы:**
    - **Высокая производительность:** Nginx обрабатывает лимиты с минимальными накладными расходами, не затрагивая ресурсы Python-сервиса.
    - **Централизованная защита:** Правило легко масштабируется и может быть применено к другим сервисам, проксируемым через этот же Gateway.
    - Значительно снижается риск успешного брутфорса и DoS-атак.
- **Минусы:**
    - **Усложнение тестирования:** Проверка логики требует end-to-end тестов, имитирующих реальные HTTP-запросы, в отличие от простых unit-тестов.
    - **Разделение конфигурации:** Логика защиты находится в конфигурации Nginx, отдельно от кода приложения, что требует внимания при развертывании.
    - Пользователи за корпоративным NAT по-прежнему могут столкнуться с временной блокировкой.

## Links
- **NFR:** `NFR-02` (Защита от подбора учётных данных), `NFR-06` (Производительность аутентификации)
- **Threat Model:** `F1` (Login Request), `Risk R1` (Блокировка сервиса из-за brute-force)
- **BDD:** Feature: Защита от подбора учётных данных
- **Реализация:** [nginx gateway](https://github.com/hse-secdev-2025-fall/course-project-AvtorPaka/blob/main/gateway/nginx.conf.template)
