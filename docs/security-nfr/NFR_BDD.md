# NFR BDD - Gherkin, SecDev Groups Activities

### Feature: Надёжное хэширование паролей (NFR-01)

**Scenario:** Пароль нового пользователя хэшируется с корректным фактором стоимости
- **Given** пользователь отправляет запрос на регистрацию с паролем `SupaSecret123!`
- **When** система успешно создаёт нового пользователя
- **Then** хэш пароля в базе данных для этого пользователя использует алгоритм `bcrypt`
- **And** фактор стоимости (cost factor) в хэше равен или больше **12**

### Feature: Защита от подбора учётных данных (NFR-02)

**Scenario:** Блокировка IP-адреса после превышения лимита неудачных попыток входа
- **Given** сервис авторизации доступен по эндпоинту `/auth/login`
- **And** для IP-адреса `*.*.*.*` не установлено никаких блокировок
- **When** с этого IP-адреса выполняется **10** последовательных запросов на вход с неверным паролем
- **Then** ответ на **10-й** запрос имеет статус `401 Unauthorized`
- **And** **11-й** запрос с того же IP-адреса блокируется со статусом `429 Too Many Requests`

### Feature: Контроль времени жизни сессии (NFR-03)

**Scenario:** Сессия пользователя становится невалидной после 3 часов неактивности
- **Given** пользователь `user@example.com` успешно аутентифицировался и получил сессионный cookie
- **When** проходит **3 часа и 1 минута** бездействия
- **And** пользователь пытается получить доступ к защищенному ресурсу `/users/change-email` с использованием старого сессионного cookie
- **Then** сервер отвечает статусом `401 Unauthorized`

### Feature: Маскирование информации в сообщениях об ошибках (NFR-04)

**Scenario:** Ответ сервера не раскрывает причину неуспешной аутентификации
- **Given** в системе существует пользователь с логином `test@example.com`
- **When** клиент отправляет POST-запрос на `/auth/login` с логином `test@example.com` и неверным паролем
- **Then** сервер отвечает статусом `401 Unauthorized` и описанием в теле ответа `{"message": "Invalid credentials"}`

**Scenario: (Негативный)** Ответ сервера одинаков для существующего и несуществующего пользователя
- **Given** в системе **не** существует пользователь с логином `nouser@example.com`
- **When** клиент отправляет POST-запрос на `/auth/login` с логином `nouser@example.com` и любым паролем
- **Then** сервер отвечает статусом `401 Unauthorized` и описанием в теле ответа `{"message": "Invalid credentials"}`

### Feature: Производительность эндпоинта аутентификации (NFR-06)

**Scenario:** Время ответа на запрос аутентификации соответствует требованиям под нагрузкой
- **Given** сервис развёрнут на `preprod`-окружении
- **And** на эндпоинт `/auth/login` подаётся нагрузка **100 RPS**
- **When** запускается 3-минутный нагрузочный тест
- **Then** **99-й перцентиль (p99)** времени ответа не превышает **500 мс**

**Scenario: (Негативный)** Система корректно обрабатывает деградацию при сверхнагрузке
- **Given** сервис развёрнут на `preprod`-окружении
- **When** на эндпоинт `/auth/login` подаётся нагрузка **200 RPS**, превышающая целевую
- **Then** сервис должен отвечать кодом `429 Too Many Requests` или `503 Service Unavailable`
- **And** не должен отвечать ошибками `500 Internal Server Error`

### Feature: Безопасные атрибуты cookie сессии (NFR-07)

**Scenario:** Сервер устанавливает сессионный cookie с защитными флагами
- **Given** клиент отправляет корректные учетные данные на эндпоинт `/auth/login`
- **When** клиент получает успешный ответ с установкой сессии
- **Then** заголовок ответа `Set-Cookie` содержит флаг `HttpOnly`
- **And** заголовок ответа `Set-Cookie` содержит флаг `Secure`
- **And** заголовок ответа `Set-Cookie` содержит атрибут `SameSite=Lax`

**Scenario: (Негативный)** Защищённый эндпоинт недоступен без сессионного cookie
- **Given** в системе существует защищённый эндпоинт `/users/change-email`
- **When** неаутентифицированный клиент отправляет запрос на этот эндпоинт
- **Then** сервер отвечает статусом `401 Unauthorized`
